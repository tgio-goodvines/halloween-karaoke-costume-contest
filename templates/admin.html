{% extends "base.html" %}
{% set title = "Admin Portal" %}

{% block content %}
<section class="admin-panel">
  <header class="admin-panel__header">
    <h2>Admin Controls</h2>
    <p>Use this dashboard to edit the costume contest and karaoke signups in real time.</p>
  </header>

  {% if errors %}
    <div class="flash flash--error">
      <h3>There were some problems:</h3>
      <ul>
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if messages %}
    <div class="flash flash--success">
      <ul>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <section class="admin-section admin-section--contest">
    <h3>Costume Contest Controls</h3>
    <p>Kick off the contest, monitor live voting, and announce the winner straight from this dashboard.</p>

    <div class="contest-actions">
      <form method="post">
        <button type="submit" name="action" value="start_costume_contest" class="button button--primary">
          Start the Costume Contest
        </button>
      </form>
      <form method="post">
        <button type="submit" name="action" value="lock_costume_winner" class="button button--accent">
          Lock In Winner
        </button>
      </form>
      <form method="post">
        <button type="submit" name="action" value="show_costume_winner" class="button">
          Show Winner on Live Display
        </button>
      </form>
      <form method="post">
        <button type="submit" name="action" value="clear_display_override" class="button button--outline">
          Restore Live Display
        </button>
      </form>
    </div>

    {% if costume_contest_state.voting_open %}
      <p class="contest-status contest-status--active">Voting is live — guests can score every costume right now.</p>
    {% elif costume_contest_state.winner_locked and costume_contest_state.winner %}
      <p class="contest-status">
        <strong>Winner locked in:</strong>
        {{ costume_contest_state.winner.name }} as {{ costume_contest_state.winner.costume }}.
      </p>
    {% endif %}

    {% if live_override %}
      <p class="contest-status">
        <strong>Live display override active:</strong>
        {{ live_override.title if live_override.title else live_override.type|replace('_', ' ')|title }}
      </p>
    {% else %}
      <p class="contest-status contest-status--inactive">Live display is currently rotating through the scheduled entries.</p>
    {% endif %}

    {% if costume_contest_state.winner_locked and costume_contest_state.winner %}
      <div class="contest-winner-card">
        <h4>Costume Contest Champion</h4>
        <p class="contest-winner-card__name">{{ costume_contest_state.winner.name }}</p>
        <p class="contest-winner-card__details">{{ costume_contest_state.winner.costume }}</p>
        <p class="contest-winner-card__metrics">
          Average: {{ '%.2f' | format(costume_contest_state.winner.average) }} • Votes: {{ costume_contest_state.winner.count }}
        </p>
      </div>
    {% endif %}

    {% if costume_contest_state.winner_locked and top_costume_rankings %}
      <div class="contest-top-card">
        <h4>Top Costume Scores</h4>
        <ol class="contest-top-card__list">
          {% for entry in top_costume_rankings %}
            <li class="contest-top-card__item">
              <span class="contest-top-card__rank">#{{ loop.index }}</span>
              <div class="contest-top-card__info">
                <span class="contest-top-card__name">{{ entry.name }}</span>
                <span class="contest-top-card__costume">as {{ entry.costume }}</span>
              </div>
              <div class="contest-top-card__score">
                <span class="contest-top-card__average">{{ '%.2f' | format(entry.average) }}</span>
                <span class="contest-top-card__votes">{{ entry.count }} vote{{ 's' if entry.count != 1 else '' }}</span>
              </div>
            </li>
          {% endfor %}
        </ol>
        <p class="contest-top-card__note">Rankings are based on final average scores out of 10.</p>
      </div>
    {% endif %}

    <div class="contest-chart">
      <h4>Vote Tally</h4>
      {% if costume_scores %}
        <div class="contest-chart__list">
          {% for entry in costume_scores %}
            <article class="contest-chart__item{% if entry.is_leader %} is-leader{% endif %}">
              <div class="contest-chart__heading">
                <span class="contest-chart__name">{{ entry.name }}</span>
                <span class="contest-chart__costume">as {{ entry.costume }}</span>
              </div>
              <div class="contest-chart__bar">
                <div class="contest-chart__bar-fill" style="--score-width: {{ '%.2f' | format(entry.percent) }}%"></div>
              </div>
              <div class="contest-chart__meta">
                <span>Average: {{ '%.2f' | format(entry.average) }}</span>
                <span>{{ entry.count }} vote{{ 's' if entry.count != 1 else '' }}</span>
              </div>
            </article>
          {% endfor %}
        </div>
        {% if costume_leader and costume_leader.count %}
          <p class="contest-leader">Current leader: <strong>{{ costume_leader.name }}</strong> with an average score of {{ '%.2f' | format(costume_leader.average) }}.</p>
        {% else %}
          <p class="contest-leader">Votes will appear here once guests start rating costumes.</p>
        {% endif %}
      {% else %}
        <p class="contest-leader">Add costume entries to begin tracking votes.</p>
      {% endif %}
    </div>
  </section>

  <div class="admin-grid">
    <section class="admin-section">
      <h3>Costume Contest Signups</h3>

      <form method="post" class="admin-entry admin-entry--new">
        <h4>Add a new entry</h4>
        <div class="admin-entry__fields">
          <label>
            Name
            <input type="text" name="name" required>
          </label>
          <label>
            Costume Description
            <input type="text" name="costume" required>
          </label>
          <label>
            Contact Details
            <input type="text" name="contact" placeholder="Optional">
          </label>
        </div>
        <button type="submit" name="action" value="add_costume" class="button button--primary">Add Costume Signup</button>
      </form>

      {% if costume_signups %}
        <div class="admin-entry-list">
          {% for signup in costume_signups %}
            <form method="post" class="admin-entry">
              <input type="hidden" name="index" value="{{ loop.index0 }}">
              <div class="admin-entry__fields">
                <label>
                  Name
                  <input type="text" name="name" value="{{ signup.name }}" required>
                </label>
                <label>
                  Costume Description
                  <input type="text" name="costume" value="{{ signup.costume }}" required>
                </label>
                <label>
                  Contact Details
                  <input type="text" name="contact" value="{{ signup.contact }}" placeholder="Optional">
                </label>
              </div>
              <div class="admin-entry__actions">
                <button type="submit" name="action" value="move_costume_up" class="button">Move Up</button>
                <button type="submit" name="action" value="move_costume_down" class="button">Move Down</button>
                <button type="submit" name="action" value="update_costume" class="button button--primary">Save Changes</button>
                <button type="submit" name="action" value="delete_costume" class="button button--danger">Remove</button>
              </div>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <p class="admin-empty">No costume signups yet.</p>
      {% endif %}
    </section>

    <section class="admin-section">
      <h3>Karaoke Signups</h3>

      <form method="post" class="admin-entry admin-entry--new">
        <h4>Add a new entry</h4>
        <div class="admin-entry__fields">
          <label>
            Name
            <input type="text" name="name" required>
          </label>
          <label>
            Song Title
            <input type="text" name="song_title" required>
          </label>
          <label>
            Artist
            <input type="text" name="artist" required>
          </label>
          <label>
            YouTube Link
            <input type="url" name="youtube_link" placeholder="https://www.youtube.com/watch?v=... (optional)" inputmode="url">
          </label>
        </div>
        <button type="submit" name="action" value="add_karaoke" class="button button--primary">Add Karaoke Signup</button>
      </form>

      {% if karaoke_signups %}
        <div class="admin-entry-list">
          {% for signup in karaoke_signups %}
            <form method="post" class="admin-entry">
              <input type="hidden" name="index" value="{{ loop.index0 }}">
              <div class="admin-entry__fields">
                <label>
                  Name
                  <input type="text" name="name" value="{{ signup.name }}" required>
                </label>
                <label>
                  Song Title
                  <input type="text" name="song_title" value="{{ signup.song_title }}" required>
                </label>
                <label>
                  Artist
                  <input type="text" name="artist" value="{{ signup.artist }}" required>
                </label>
                <label>
                  YouTube Link
                  <input type="url" name="youtube_link" value="{{ signup.youtube_link }}" placeholder="https://www.youtube.com/watch?v=... (optional)" inputmode="url">
                </label>
              </div>
              <div class="admin-entry__actions">
                <button type="submit" name="action" value="move_karaoke_up" class="button">Move Up</button>
                <button type="submit" name="action" value="move_karaoke_down" class="button">Move Down</button>
                <button type="submit" name="action" value="update_karaoke" class="button button--primary">Save Changes</button>
                <button type="submit" name="action" value="delete_karaoke" class="button button--danger">Remove</button>
              </div>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <p class="admin-empty">No karaoke signups yet.</p>
      {% endif %}
    </section>
  </div>
</section>
{% endblock %}
